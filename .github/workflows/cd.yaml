name: CD

on:
  push:
    branches: [main, develop]
  workflow_run:
    workflows: [CI]
    types: [completed]
    branches: [main, develop]

jobs:
  deploy:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        env:
          - { name: production, branch: main }
          - { name: staging, branch: develop }
    name: Deploy to ${{ matrix.env.name }}
    if: github.ref == format('refs/heads/{0}', matrix.env.branch) && (github.event_name == 'push' || github.event.workflow_run.conclusion == 'success')

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'yarn'

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Build application
        run: yarn build
        env:
          NODE_ENV: ${{ matrix.env.name }}

      - name: Run database migrations
        run: yarn migration:run
        env:
          NODE_ENV: ${{ matrix.env.name }}
          DB_HOST: ${{ secrets[format('{0}_DB_HOST', matrix.env.name == 'production' && 'DB' || 'STAGING_DB')] }}
          DB_PORT: ${{ secrets[format('{0}_DB_PORT', matrix.env.name == 'production' && 'DB' || 'STAGING_DB')] }}
          DB_USER: ${{ secrets[format('{0}_DB_USER', matrix.env.name == 'production' && 'DB' || 'STAGING_DB')] }}
          DB_PASSWORD: ${{ secrets[format('{0}_DB_PASSWORD', matrix.env.name == 'production' && 'DB' || 'STAGING_DB')] }}
          DB_NAME: ${{ secrets[format('{0}_DB_NAME', matrix.env.name == 'production' && 'DB' || 'STAGING_DB')] }}
          REDIS_HOST: ${{ secrets[format('{0}_REDIS_HOST', matrix.env.name == 'production' && 'REDIS' || 'STAGING_REDIS')] }}
          REDIS_PORT: ${{ secrets[format('{0}_REDIS_PORT', matrix.env.name == 'production' && 'REDIS' || 'STAGING_REDIS')] }}

      - name: Deploy to ${{ matrix.env.name }} server
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets[format('{0}_DEPLOY_KEY', matrix.env.name == 'production' && 'DEPLOY' || 'STAGING_DEPLOY')] }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets[format('{0}_DEPLOY_HOST', matrix.env.name == 'production' && 'DEPLOY' || 'STAGING_DEPLOY')] }} >> ~/.ssh/known_hosts 2>/dev/null
          scp -i ~/.ssh/deploy_key -r dist/ ${{ secrets[format('{0}_DEPLOY_USER', matrix.env.name == 'production' && 'DEPLOY' || 'STAGING_DEPLOY')] }}@${{ secrets[format('{0}_DEPLOY_HOST', matrix.env.name == 'production' && 'DEPLOY' || 'STAGING_DEPLOY')] }}:${{ secrets[format('{0}_DEPLOY_PATH', matrix.env.name == 'production' && 'DEPLOY' || 'STAGING_DEPLOY')] }}/
          scp -i ~/.ssh/deploy_key package.json yarn.lock ${{ secrets[format('{0}_DEPLOY_USER', matrix.env.name == 'production' && 'DEPLOY' || 'STAGING_DEPLOY')] }}@${{ secrets[format('{0}_DEPLOY_HOST', matrix.env.name == 'production' && 'DEPLOY' || 'STAGING_DEPLOY')] }}:${{ secrets[format('{0}_DEPLOY_PATH', matrix.env.name == 'production' && 'DEPLOY' || 'STAGING_DEPLOY')] }}/
          ssh -i ~/.ssh/deploy_key ${{ secrets[format('{0}_DEPLOY_USER', matrix.env.name == 'production' && 'DEPLOY' || 'STAGING_DEPLOY')] }}@${{ secrets[format('{0}_DEPLOY_HOST', matrix.env.name == 'production' && 'DEPLOY' || 'STAGING_DEPLOY')] }} "cd ${{ secrets[format('{0}_DEPLOY_PATH', matrix.env.name == 'production' && 'DEPLOY' || 'STAGING_DEPLOY')] }} && yarn install --frozen-lockfile --production && pm2 restart recommend-be${{ matrix.env.name == 'staging' && '-staging' || '' }} || pm2 start dist/main.js --name recommend-be${{ matrix.env.name == 'staging' && '-staging' || '' }}"
        env:
          NODE_ENV: ${{ matrix.env.name }}

      - name: Slack Notification
        if: always()
        uses: slackapi/slack-github-action@v1
        with:
          webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }}
          payload: |
            {
              "text": "${{ job.status == 'success' && '✅' || '❌' }} ${{ matrix.env.name }} Deployment ${{ job.status == 'success' && 'Successful' || 'Failed' }}",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*${{ matrix.env.name | upper }} Deployment ${{ job.status == 'success' && 'Successful ✅' || 'Failed ❌' }}*\n*Repository:* ${{ github.repository }}\n*Branch:* ${{ github.ref_name }}\n*Commit:* ${{ github.sha }}\n*Author:* ${{ github.actor }}"
                  }
                }
              ]
            }